<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== C·∫§U H√åNH ===== */
const ADMIN_PASS = "123456";

/* ===== TI·ªÜN √çCH ===== */
const today = () => new Date().toISOString().slice(0,10);
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===== ·∫®N / HI·ªÜN SCREEN (KH√îNG ƒê·ª§NG #reader) ===== */
function hideScreens(){
  menu.style.display="none";
  loginScreen.style.display="none";
  adminScreen.style.display="none";
  storeScreen.style.display="none";
  scanScreen.style.display="none";
  resultScreen.style.display="none";
}

/* ===== ƒêI·ªÄU H∆Ø·ªöNG ===== */
function goHome(){ location.reload(); }
function goEmployee(){ hideScreens(); storeScreen.style.display="block"; }
function goLogin(){ hideScreens(); loginScreen.style.display="block"; }

/* ===== LOGIN ===== */
function login(){
  if(password.value !== ADMIN_PASS) return alert("‚ùå Sai m·∫≠t kh·∫©u");
  localStorage.setItem("ADMIN","1");
  hideScreens();
  adminScreen.style.display="block";
}
function logout(){
  localStorage.removeItem("ADMIN");
  goHome();
}

/* ===== SESSION ===== */
let CURRENT_STORE = null;

function startSession(){
  if(!storeSelect.value) return alert("‚ùå Ch∆∞a ch·ªçn c·ª≠a h√†ng");
  CURRENT_STORE = storeSelect.value;
  localStorage.setItem("CURRENT_STORE", CURRENT_STORE);

  hideScreens();
  scanScreen.style.display="block";
  currentStore.innerText = CURRENT_STORE;

  setTimeout(startCamera, 300); // ‚¨ÖÔ∏è r·∫•t quan tr·ªçng
}

/* ===== CAMERA (INSTANCE DUY NH·∫§T) ===== */
let qrScanner = null;

function startCamera(){
  if(qrScanner){
    qrScanner.clear().catch(()=>{});
  }

  qrScanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cams=>{
    if(!cams.length) return alert("‚ùå Kh√¥ng t√¨m th·∫•y camera");

    const cam =
      cams.find(c=>/back|rear|environment/i.test(c.label))
      || cams[cams.length-1];

    qrScanner.start(
      cam.id,
      { fps: 10, qrbox: 250 },
      onScan
    );
  });
}

/* ===== QU√âT ===== */
function onScan(text){
  const master = load("MASTER");
  const item = master.find(x=>x.qr===text);

  if(master.length && !item) return alert("‚ùå H√ÄNG NGO√ÄI");
  if(item?.sold) return alert("‚ùå ƒê√É B√ÅN");
  if(item && item.store!==CURRENT_STORE) return alert("‚ö†Ô∏è SAI C·ª¨A H√ÄNG");

  qrScanner.stop();
  window.currentQR = text;

  qrValue.innerText = text;
  resultScreen.style.display="block";
}

/* ===== GHI NH·∫¨N ===== */
function saveCheck(){
  const key = "CHECK_"+today()+"_"+CURRENT_STORE;
  let c = load(key).filter(x=>x!==currentQR);
  c.push(currentQR);
  save(key,c);

  let h = load("HISTORY");
  h.push({qr:currentQR,store:CURRENT_STORE,time:new Date().toLocaleString()});
  save("HISTORY",h);

  resumeScan();
}

function resumeScan(){
  resultScreen.style.display="none";
  setTimeout(startCamera,300);
}

/* ===== MASTER ===== */
function showImport(){
  if(!localStorage.getItem("ADMIN")) return alert("‚ùå Kh√¥ng c√≥ quy·ªÅn");
  document.body.innerHTML=`
    <h3>üì• NH·∫¨P / C·∫¨P NH·∫¨T MASTER</h3>
    <textarea id="input" rows="10" style="width:100%"
    placeholder="QR001,242"></textarea><br>
    <button onclick="importMaster()">üíæ L∆∞u</button>
    <button onclick="location.reload()">‚¨Ö Trang ch·ªß</button>`;
}

function importMaster(){
  let m=[];
  input.value.trim().split("\n").forEach(l=>{
    let [qr,store]=l.split(",");
    if(qr&&store) m.push({qr:qr.trim(),store:store.trim(),sold:false});
  });
  save("MASTER",m);
  alert("‚úÖ MASTER ƒë√£ c·∫≠p nh·∫≠t");
  location.reload();
}

/* ===== B√ÅO C√ÅO ===== */
function showSummary(){
  if(!CURRENT_STORE) return alert("‚ùå Ch∆∞a ch·ªçn c·ª≠a h√†ng");
  const m=load("MASTER").filter(x=>!x.sold&&x.store===CURRENT_STORE);
  const c=load("CHECK_"+today()+"_"+CURRENT_STORE);

  let html=`<h3>üìä ${CURRENT_STORE}</h3><div class="box">`;
  let warn=false;
  m.forEach(x=>{
    if(!c.includes(x.qr)){
      warn=true;
      html+=`<div class="warn">‚ùå ${x.qr}</div>`;
    }
  });
  if(!warn) html+=`<div class="ok">‚úÖ OK</div>`;
  html+=`</div><button onclick="location.reload()">‚¨Ö Trang ch·ªß</button>`;
  document.body.innerHTML=html;
}

function showHistory(){
  let html=`<h3>üìú L·ªäCH S·ª¨</h3><div class="box">`;
  load("HISTORY").forEach(x=>{
    html+=`${x.time} | ${x.qr} | ${x.store}<br>`;
  });
  html+=`</div><button onclick="location.reload()">‚¨Ö Trang ch·ªß</button>`;
  document.body.innerHTML=html;
}
</script>
