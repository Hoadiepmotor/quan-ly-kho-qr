<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Quáº£n lÃ½ kho QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 10px;
}
#reader {
  width: 100%;
  max-width: 400px;
  margin: auto;
}
select, button {
  font-size: 16px;
  padding: 8px;
  margin: 6px;
}
.warn { color:red; font-weight:bold }
.ok { color:green; font-weight:bold }
.box {
  border:1px solid #ccc;
  padding:10px;
  margin:10px;
  border-radius:8px;
}
</style>
</head>

<body>

<h2>ğŸ“¦ Quáº£n lÃ½ kho QR</h2>

<!-- ================= QUÃ‰T QR ================= -->
<div id="scanScreen">
  <div id="reader"></div>
  <div id="result">ChÆ°a quÃ©t QR</div>
</div>

<!-- ================= Káº¾T QUáº¢ ================= -->
<div id="resultScreen" style="display:none">
  <h3>ThÃ´ng tin QR</h3>
  <p id="qrValue"></p>

  <label>HÃ nh Ä‘á»™ng</label><br>
  <select id="action">
    <option value="in">Nháº­p kho</option>
    <option value="out">Xuáº¥t bÃ¡n</option>
    <option value="move">Äiá»u chuyá»ƒn</option>
    <option value="check">Kiá»ƒm kÃª</option>
  </select><br>

  <label>Cá»­a hÃ ng</label><br>
  <select id="store">
    <option>242</option>
    <option>250</option>
    <option>300</option>
    <option>239</option>
    <option>891</option>
    <option>581</option>
  </select><br>

  <button onclick="saveAction()">ğŸ’¾ LÆ°u</button>
  <button onclick="location.reload()">ğŸ” QuÃ©t láº¡i</button>
</div>

<hr>

<button onclick="showSummary()">ğŸ“Š Káº¾T QUáº¢ KIá»‚M KÃŠ</button>
<button onclick="showHistory()">ğŸ“œ Lá»ŠCH Sá»¬</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* =========================
   DANH SÃCH Gá»C (MASTER)
   ğŸ‘‰ SAU NÃ€Y Báº N CÃ“ THá»‚
   Äá»”I THÃ€NH GOOGLE SHEET
========================= */
const MASTER = JSON.parse(localStorage.getItem("MASTER") || "[]");

/* =========================
   TIá»†N ÃCH
========================= */
const today = () => new Date().toISOString().slice(0,10);
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* =========================
   CAMERA SAU
========================= */
const qr = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(cams=>{
  const cam = cams.find(c=>c.label.toLowerCase().includes("back")) || cams[cams.length-1];
  qr.start(cam.id,{fps:10,qrbox:250},onScan);
});

function onScan(text){
  qr.stop();
  window.currentQR = text;
  document.getElementById("qrValue").innerHTML = "<b>"+text+"</b>";
  document.getElementById("scanScreen").style.display="none";
  document.getElementById("resultScreen").style.display="block";
}

/* =========================
   LÆ¯U HÃ€NH Äá»˜NG
   â— KHÃ”NG BAO GIá»œ Bá»Š TRÃ™NG
========================= */
function saveAction(){
  const action = document.getElementById("action").value;
  const store  = document.getElementById("store").value;

  /* ===== Lá»ŠCH Sá»¬ ===== */
  const history = load("HISTORY");
  history.push({
    qr: currentQR,
    action,
    store,
    time: new Date().toLocaleString()
  });
  save("HISTORY", history);

  /* ===== MASTER ===== */
  let master = load("MASTER");
  let item = master.find(x=>x.qr===currentQR);

  if(!item){
    item = { qr: currentQR, store, sold:false };
    master.push(item);
  }

  if(action==="out"){
    item.sold = true;           // bÃ¡n xong â†’ khÃ´ng kiá»ƒm kÃª
  } else {
    item.store = store;        // nháº­p / Ä‘iá»u chuyá»ƒn
  }

  save("MASTER", master);

  /* ===== KIá»‚M KÃŠ (1 QR = 1 DÃ’NG) ===== */
  if(action!=="out"){
    const key = "CHECK_"+today();
    let checks = load(key);

    // âŒ xÃ³a báº£n ghi cÅ© cÃ¹ng QR
    checks = checks.filter(c=>c.qr!==currentQR);

    // âœ… ghi láº¡i
    checks.push({qr:currentQR,store});
    save(key,checks);
  }

  alert("ÄÃ£ lÆ°u âœ”");
  location.reload();
}

/* =========================
   Káº¾T QUáº¢ KIá»‚M KÃŠ
========================= */
function showSummary(){
  const checks = load("CHECK_"+today());
  const master = load("MASTER");

  let warn = false;
  let html = `<h3>ğŸ“Š Káº¾T QUáº¢ KIá»‚M KÃŠ ${today()}</h3><div class="box">`;

  master.forEach(x=>{
    if(x.sold) return;
    const found = checks.find(c=>c.qr===x.qr && c.store===x.store);
    if(!found){
      warn = true;
      html += `<div class="warn">ğŸš¨ ${x.qr} | Cá»­a hÃ ng ${x.store}</div>`;
    }
  });

  if(!warn){
    html += `<div class="ok">âœ… XONG â€“ KHÃ”NG CÃ“ Cáº¢NH BÃO</div>`;
  }

  html += `</div><button onclick="location.reload()">â¬… Quay láº¡i</button>`;
  document.body.innerHTML = html;
}

/* =========================
   Lá»ŠCH Sá»¬
========================= */
function showHistory(){
  const h = load("HISTORY");
  let html = `<h3>ğŸ“œ Lá»ŠCH Sá»¬ THAO TÃC</h3><div class="box">`;

  h.forEach(x=>{
    html += `${x.time} | ${x.qr} | ${x.action} | CH ${x.store}<br>`;
  });

  html += `</div><button onclick="location.reload()">â¬… Quay láº¡i</button>`;
  document.body.innerHTML = html;
}
</script>

</body>
</html>
