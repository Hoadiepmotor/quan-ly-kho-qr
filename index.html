<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Quáº£n lÃ½ kho QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; text-align: center; padding: 10px; }
#reader { width: 100%; max-width: 400px; margin: auto; }
select, button, textarea, input {
  font-size: 16px; padding: 8px; margin: 6px;
}
.warn { color:red; font-weight:bold }
.ok { color:green; font-weight:bold }
.box { border:1px solid #ccc; padding:10px; margin:10px; border-radius:8px; }
</style>
</head>

<body>

<h2>ğŸ“¦ Quáº£n lÃ½ kho QR</h2>

<!-- ================= MENU ================= -->
<div id="menu">
  <button onclick="goEmployee()">ğŸ‘· NhÃ¢n viÃªn</button>
  <button onclick="goLogin()">ğŸ‘¨â€ğŸ’¼ Quáº£n lÃ½</button>
</div>

<!-- ================= LOGIN ================= -->
<div id="loginScreen" style="display:none">
  <h3>ğŸ” ÄÄƒng nháº­p quáº£n lÃ½</h3>
  <input type="password" id="password" placeholder="Máº­t kháº©u"><br>
  <button onclick="login()">ÄÄƒng nháº­p</button>
  <button onclick="goHome()">â¬… Trang chá»§</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminScreen" style="display:none">
  <h3>ğŸ‘¨â€ğŸ’¼ QUáº¢N LÃ</h3>
  <button onclick="showImport()">ğŸ“¥ Nháº­p / cáº­p nháº­t MASTER</button><br>
  <button onclick="showMaster()">ğŸ“‹ Xem danh sÃ¡ch MASTER</button><br>
  <button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button><br>
  <button onclick="goHome()">â¬… Trang chá»§</button>
</div>

<!-- ================= STORE ================= -->
<div id="storeScreen" style="display:none">
  <h3>ğŸª Chá»n cá»­a hÃ ng</h3>
  <select id="storeSelect">
    <option value="">-- Chá»n --</option>
    <option>242</option>
    <option>250</option>
    <option>300</option>
    <option>239</option>
    <option>891</option>
    <option>581</option>
  </select><br>
  <button onclick="startSession()">â–¶ Báº¯t Ä‘áº§u</button>
  <button onclick="goHome()">â¬… Trang chá»§</button>
</div>

<!-- ================= SCAN ================= -->
<div id="scanScreen" style="display:none">
  <h3>ğŸ“· Kiá»ƒm kÃª CH <span id="currentStore"></span></h3>
  <div id="reader"></div>
  <button onclick="goHome()">â¬… Trang chá»§</button>
</div>

<!-- ================= RESULT ================= -->
<div id="resultScreen" style="display:none">
  <h3 id="qrValue"></h3>
  <button onclick="saveCheck()">ğŸ’¾ Ghi nháº­n</button>
  <button onclick="resumeScan()">ğŸ” QuÃ©t tiáº¿p</button>
</div>

<hr>
<button onclick="showSummary()">ğŸ“Š Káº¿t quáº£</button>
<button onclick="showHistory()">ğŸ“œ Lá»‹ch sá»­</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== Cáº¤U HÃŒNH ===== */
const ADMIN_PASS = "123456";

/* ===== TIá»†N ÃCH ===== */
const today = () => new Date().toISOString().slice(0,10);
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const hideAll = () =>
  document.querySelectorAll("div").forEach(d=>d.style.display="none");

/* ===== ÄIá»€U HÆ¯á»šNG ===== */
function goHome(){ location.reload(); }
function goEmployee(){ hideAll(); storeScreen.style.display="block"; }
function goLogin(){ hideAll(); loginScreen.style.display="block"; }

/* ===== LOGIN ===== */
function login(){
  if(password.value !== ADMIN_PASS) return alert("âŒ Sai máº­t kháº©u");
  localStorage.setItem("ADMIN","1");
  hideAll();
  adminScreen.style.display="block";
}
function logout(){
  localStorage.removeItem("ADMIN");
  goHome();
}

/* ===== SESSION ===== */
let CURRENT_STORE = null;

function startSession(){
  if(!storeSelect.value) return alert("âŒ ChÆ°a chá»n cá»­a hÃ ng");
  CURRENT_STORE = storeSelect.value;
  localStorage.setItem("CURRENT_STORE",CURRENT_STORE);
  hideAll();
  scanScreen.style.display="block";
  currentStore.innerText = CURRENT_STORE;
  startCamera();
}

/* ===== CAMERA ===== */
let qrScanner;

function startCamera(){
  qrScanner = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams=>{
    const cam =
      cams.find(c=>/back|rear|environment/i.test(c.label)) || cams[cams.length-1];
    qrScanner.start(cam.id,{fps:10,qrbox:250},onScan);
  });
}

/* ===== SCAN LOGIC ===== */
function onScan(text){
  const master = load("MASTER");
  const item = master.find(x=>x.qr===text);

  if(master.length && !item){
    alert("âŒ MÃƒ KHÃ”NG CÃ“ TRONG Cá»¬A HÃ€NG");
    return;
  }

  if(item?.sold){
    alert("âŒ MÃƒ ÄÃƒ BÃN");
    return;
  }

  if(item && item.store !== CURRENT_STORE){
    alert("âš ï¸ SAI Cá»¬A HÃ€NG");
    return;
  }

  qrScanner.stop();
  window.currentQR = text;
  qrValue.innerText = text;
  resultScreen.style.display="block";
}

/* ===== SAVE CHECK ===== */
function saveCheck(){
  const key = "CHECK_"+today()+"_"+CURRENT_STORE;
  let c = load(key).filter(x=>x!==currentQR);
  c.push(currentQR);
  save(key,c);

  let h = load("HISTORY");
  h.push({qr:currentQR,store:CURRENT_STORE,time:new Date().toLocaleString()});
  save("HISTORY",h);

  resumeScan();
}

function resumeScan(){
  resultScreen.style.display="none";
  setTimeout(()=>startCamera(),500);
}

/* ===== MASTER ===== */
function showImport(){
  if(!localStorage.getItem("ADMIN")) return alert("âŒ KhÃ´ng cÃ³ quyá»n");
  document.body.innerHTML=`
    <h3>ğŸ“¥ NHáº¬P / Cáº¬P NHáº¬T MASTER</h3>
    <textarea id="input" rows="10" style="width:100%"
    placeholder="QR001,242"></textarea><br>
    <button onclick="importMaster()">ğŸ’¾ LÆ°u</button>
    <button onclick="location.reload()">â¬… Trang chá»§</button>`;
}

function importMaster(){
  let m=[];
  input.value.trim().split("\n").forEach(l=>{
    let [qr,store]=l.split(",");
    if(qr&&store) m.push({qr:qr.trim(),store:store.trim(),sold:false});
  });
  save("MASTER",m);
  alert("âœ… MASTER Ä‘Ã£ cáº­p nháº­t");
  location.reload();
}

function showMaster(){
  if(!localStorage.getItem("ADMIN")) return alert("âŒ KhÃ´ng cÃ³ quyá»n");
  const m = load("MASTER");
  let html = `<h3>ğŸ“‹ MASTER (${m.length})</h3><div class="box">`;
  m.forEach(x=>{
    html+=`${x.qr} | CH ${x.store}<br>`;
  });
  html+=`</div><button onclick="location.reload()">â¬… Trang chá»§</button>`;
  document.body.innerHTML=html;
}

/* ===== REPORT ===== */
function showSummary(){
  if(!CURRENT_STORE) return alert("âŒ ChÆ°a chá»n cá»­a hÃ ng");
  const m=load("MASTER").filter(x=>x.store===CURRENT_STORE);
  const c=load("CHECK_"+today()+"_"+CURRENT_STORE);
  let html=`<h3>ğŸ“Š ${CURRENT_STORE}</h3><div class="box">`;
  let warn=false;
  m.forEach(x=>{
    if(!c.includes(x.qr)){warn=true;html+=`<div class="warn">âŒ ${x.qr}</div>`;}
  });
  if(!warn) html+=`<div class="ok">âœ… OK</div>`;
  html+=`</div><button onclick="location.reload()">â¬… Trang chá»§</button>`;
  document.body.innerHTML=html;
}

function showHistory(){
  let html=`<h3>ğŸ“œ Lá»ŠCH Sá»¬</h3><div class="box">`;
  load("HISTORY").forEach(x=>{
    html+=`${x.time} | ${x.qr} | ${x.store}<br>`;
  });
  html+=`</div><button onclick="location.reload()">â¬… Trang chá»§</button>`;
  document.body.innerHTML=html;
}
</script>

</body>
</html>
