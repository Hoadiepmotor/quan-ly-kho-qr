<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Quáº£n lÃ½ kho QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; text-align: center; padding: 10px; }
#reader { width: 100%; max-width: 400px; margin: auto; }
select, button, textarea, input {
  font-size: 16px; padding: 8px; margin: 6px;
}
.warn { color:red; font-weight:bold }
.ok { color:green; font-weight:bold }
.box { border:1px solid #ccc; padding:10px; margin:10px; border-radius:8px; }
</style>
</head>

<body>

<h2>ğŸ“¦ Quáº£n lÃ½ kho QR</h2>

<!-- ================= MENU ================= -->
<div id="menu">
  <button onclick="showStore()">ğŸ‘· NhÃ¢n viÃªn</button>
  <button onclick="showLogin()">ğŸ‘¨â€ğŸ’¼ Quáº£n lÃ½</button>
</div>

<!-- ================= LOGIN ================= -->
<div id="loginScreen" style="display:none">
  <h3>ğŸ” ÄÄƒng nháº­p quáº£n lÃ½</h3>
  <input type="password" id="password" placeholder="Nháº­p máº­t kháº©u"><br>
  <button onclick="login()">ÄÄƒng nháº­p</button>
  <button onclick="location.reload()">â¬… Quay láº¡i</button>
</div>

<!-- ================= QUáº¢N LÃ ================= -->
<div id="adminScreen" style="display:none">
  <h3>ğŸ‘¨â€ğŸ’¼ QUáº¢N LÃ</h3>
  <button onclick="showImport()">ğŸ“¥ Nháº­p danh sÃ¡ch chuáº©n</button><br>
  <button onclick="resetAll()">ğŸ—‘ Reset dá»¯ liá»‡u kiá»ƒm kÃª</button><br>
  <button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
</div>

<!-- ================= NHÃ‚N VIÃŠN ================= -->
<div id="storeScreen" style="display:none">
  <h3>ğŸª Chá»n cá»­a hÃ ng</h3>
  <select id="storeSelect">
    <option value="">-- Chá»n cá»­a hÃ ng --</option>
    <option>242</option>
    <option>250</option>
    <option>300</option>
    <option>239</option>
    <option>891</option>
    <option>581</option>
  </select><br>
  <button onclick="startSession()">â–¶ Báº¯t Ä‘áº§u kiá»ƒm kÃª</button>
</div>

<!-- ================= QUÃ‰T QR ================= -->
<div id="scanScreen" style="display:none">
  <h3>ğŸ“· Kiá»ƒm kÃª cá»­a hÃ ng <span id="currentStore"></span></h3>
  <div id="reader"></div>
</div>

<!-- ================= Káº¾T QUáº¢ ================= -->
<div id="resultScreen" style="display:none">
  <h3 id="qrValue"></h3>
  <button onclick="saveCheck()">ğŸ’¾ Ghi nháº­n</button>
  <button onclick="resumeScan()">ğŸ” QuÃ©t tiáº¿p</button>
</div>

<hr>
<button onclick="showSummary()">ğŸ“Š Káº¿t quáº£</button>
<button onclick="showHistory()">ğŸ“œ Lá»‹ch sá»­</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== Cáº¤U HÃŒNH ===== */
const ADMIN_PASS = "123456"; // ğŸ”´ Äá»”I Máº¬T KHáº¨U Táº I ÄÃ‚Y

/* ===== TIá»†N ÃCH ===== */
const today = () => new Date().toISOString().slice(0,10);
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===== MENU ===== */
function showStore(){
  menu.style.display="none";
  storeScreen.style.display="block";
}

function showLogin(){
  menu.style.display="none";
  loginScreen.style.display="block";
}

/* ===== LOGIN ===== */
function login(){
  if(password.value !== ADMIN_PASS) return alert("âŒ Sai máº­t kháº©u");
  localStorage.setItem("ADMIN","1");
  loginScreen.style.display="none";
  adminScreen.style.display="block";
}

function logout(){
  localStorage.removeItem("ADMIN");
  location.reload();
}

/* ===== SESSION NHÃ‚N VIÃŠN ===== */
function startSession(){
  if(!storeSelect.value) return alert("âŒ ChÆ°a chá»n cá»­a hÃ ng");
  localStorage.setItem("CURRENT_STORE",storeSelect.value);
  location.reload();
}

const CURRENT_STORE = localStorage.getItem("CURRENT_STORE");

/* ===== CAMERA ===== */
let qr;
function startCamera(){
  qr = new Html5Qrcode("reader");
  Html5Qrcode.getCameras().then(cams=>{
    qr.start(cams[0].id,{fps:10,qrbox:250},onScan);
  });
}

/* ===== QUÃ‰T ===== */
function onScan(text){
  const master = load("MASTER");
  const item = master.find(x=>x.qr===text);

  if(master.length && !item) return alert("âŒ HÃ€NG NGOÃ€I");
  if(item.sold) return alert("âŒ ÄÃƒ BÃN");
  if(item.store!==CURRENT_STORE) return alert("âš ï¸ SAI Cá»¬A HÃ€NG");

  qr.stop();
  window.currentQR=text;
  qrValue.innerText=text;
  resultScreen.style.display="block";
}

/* ===== GHI NHáº¬N ===== */
function saveCheck(){
  const key="CHECK_"+today()+"_"+CURRENT_STORE;
  let c=load(key).filter(x=>x!==currentQR);
  c.push(currentQR);
  save(key,c);

  const h=load("HISTORY");
  h.push({qr:currentQR,store:CURRENT_STORE,time:new Date().toLocaleString()});
  save("HISTORY",h);

  resumeScan();
}

function resumeScan(){
  resultScreen.style.display="none";
  startCamera();
}

/* ===== MASTER ===== */
function showImport(){
  document.body.innerHTML=`
  <h3>ğŸ“¥ NHáº¬P MASTER</h3>
  <textarea id="input" rows="10" style="width:100%"
  placeholder="QR001,242"></textarea><br>
  <button onclick="importMaster()">ğŸ’¾ LÆ°u</button>
  <button onclick="location.reload()">â¬… Quay láº¡i</button>`;
}

function importMaster(){
  if(!localStorage.getItem("ADMIN")) return alert("âŒ KhÃ´ng cÃ³ quyá»n");
  let m=[];
  input.value.trim().split("\n").forEach(l=>{
    let [qr,store]=l.split(",");
    if(qr&&store) m.push({qr:qr.trim(),store:store.trim(),sold:false});
  });
  save("MASTER",m);
  alert("âœ… ÄÃ£ nháº­p MASTER");
  location.reload();
}

/* ===== RESET ===== */
function resetAll(){
  if(!confirm("Reset toÃ n bá»™ kiá»ƒm kÃª?")) return;
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith("CHECK_")||k==="HISTORY") localStorage.removeItem(k);
  });
  alert("âœ… ÄÃ£ reset");
}

/* ===== BÃO CÃO ===== */
function showSummary(){
  const m=load("MASTER").filter(x=>!x.sold&&x.store===CURRENT_STORE);
  const c=load("CHECK_"+today()+"_"+CURRENT_STORE);
  let h=`<h3>ğŸ“Š ${CURRENT_STORE}</h3><div class="box">`;
  let w=false;
  m.forEach(x=>{
    if(!c.includes(x.qr)){w=true;h+=`<div class="warn">âŒ ${x.qr}</div>`;}
  });
  if(!w) h+=`<div class="ok">âœ… OK</div>`;
  h+=`</div><button onclick="location.reload()">â¬…</button>`;
  document.body.innerHTML=h;
}

function showHistory(){
  let h=`<h3>ğŸ“œ Lá»ŠCH Sá»¬</h3><div class="box">`;
  load("HISTORY").forEach(x=>{
    h+=`${x.time} | ${x.qr} | ${x.store}<br>`;
  });
  h+=`</div><button onclick="location.reload()">â¬…</button>`;
  document.body.innerHTML=h;
}

/* ===== AUTO ===== */
if(CURRENT_STORE){
  menu.style.display="none";
  storeScreen.style.display="none";
  scanScreen.style.display="block";
  currentStore.innerText=CURRENT_STORE;
  startCamera();
}
</script>

</body>
</html>
