<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Quáº£n lÃ½ kho QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; text-align: center; padding: 10px; }
button, select, input, textarea {
  font-size:16px; padding:8px; margin:6px;
}
#reader { width:100%; max-width:400px; margin:auto; }
.box { border:1px solid #ccc; padding:10px; margin:10px; border-radius:8px; }
.warn { color:red; font-weight:bold }
.ok { color:green; font-weight:bold }
</style>
</head>

<body>

<h2>ğŸ“¦ Quáº£n lÃ½ kho QR</h2>

<!-- ===== MENU ===== -->
<div id="menu">
  <button onclick="goEmployee()">ğŸ‘· NhÃ¢n viÃªn</button>
  <button onclick="goLogin()">ğŸ‘¨â€ğŸ’¼ Quáº£n lÃ½</button>
</div>

<!-- ===== LOGIN ===== -->
<div id="loginScreen" style="display:none">
  <h3>ğŸ” ÄÄƒng nháº­p quáº£n lÃ½</h3>
  <input type="password" id="password" placeholder="Máº­t kháº©u"><br>
  <button onclick="login()">ÄÄƒng nháº­p</button>
  <button onclick="goHome()">â¬… Trang chá»§</button>
</div>

<!-- ===== ADMIN ===== -->
<div id="adminScreen" style="display:none">
  <h3>ğŸ‘¨â€ğŸ’¼ QUáº¢N LÃ</h3>
  <button onclick="showImport()">ğŸ“¥ Nháº­p / cáº­p nháº­t MASTER</button><br>
  <button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button><br>
  <button onclick="goHome()">â¬… Trang chá»§</button>
</div>

<!-- ===== CHá»ŒN Cá»¬A HÃ€NG ===== -->
<div id="storeScreen" style="display:none">
  <h3>ğŸª Chá»n cá»­a hÃ ng</h3>
  <select id="storeSelect">
    <option value="">-- Chá»n --</option>
    <option>242</option>
    <option>250</option>
    <option>300</option>
    <option>239</option>
    <option>891</option>
    <option>581</option>
  </select><br>
  <button onclick="startSession()">â–¶ Báº¯t Ä‘áº§u kiá»ƒm kÃª</button>
  <button onclick="goHome()">â¬… Trang chá»§</button>
</div>

<!-- ===== SCAN (KHÃ”NG display:none) ===== -->
<div id="scanScreen" style="visibility:hidden; height:0">
  <h3>ğŸ“· Kiá»ƒm kÃª cá»­a hÃ ng <span id="currentStore"></span></h3>
  <div id="reader"></div>
</div>

<!-- ===== RESULT ===== -->
<div id="resultScreen" style="display:none">
  <h3 id="qrValue"></h3>
  <button onclick="saveCheck()">ğŸ’¾ Ghi nháº­n</button>
  <button onclick="resumeScan()">ğŸ” QuÃ©t tiáº¿p</button>
</div>

<hr>
<button onclick="showSummary()">ğŸ“Š Káº¿t quáº£</button>
<button onclick="showHistory()">ğŸ“œ Lá»‹ch sá»­</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== Cáº¤U HÃŒNH ===== */
const ADMIN_PASS = "123456";

/* ===== TIá»†N ÃCH ===== */
const today = () => new Date().toISOString().slice(0,10);
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===== áº¨N SCREEN ===== */
function hideScreens(){
  menu.style.display="none";
  loginScreen.style.display="none";
  adminScreen.style.display="none";
  storeScreen.style.display="none";
  resultScreen.style.display="none";
}

/* ===== ÄIá»€U HÆ¯á»šNG ===== */
function goHome(){ location.reload(); }
function goEmployee(){ hideScreens(); storeScreen.style.display="block"; }
function goLogin(){ hideScreens(); loginScreen.style.display="block"; }

/* ===== LOGIN ===== */
function login(){
  if(password.value !== ADMIN_PASS) return alert("âŒ Sai máº­t kháº©u");
  localStorage.setItem("ADMIN","1");
  hideScreens();
  adminScreen.style.display="block";
}
function logout(){
  localStorage.removeItem("ADMIN");
  goHome();
}

/* ===== SESSION ===== */
let CURRENT_STORE = null;

function startSession(){
  if(!storeSelect.value) return alert("âŒ ChÆ°a chá»n cá»­a hÃ ng");

  CURRENT_STORE = storeSelect.value;
  localStorage.setItem("CURRENT_STORE", CURRENT_STORE);

  hideScreens();

  scanScreen.style.visibility="visible";
  scanScreen.style.height="auto";
  scanScreen.style.display="block";

  currentStore.innerText = CURRENT_STORE;

  setTimeout(startCamera, 500);
}

/* ===== CAMERA ===== */
let qrScanner = null;

function startCamera(){
  if(qrScanner){
    qrScanner.clear().catch(()=>{});
  }

  qrScanner = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cams=>{
    if(!cams.length) return alert("âŒ KhÃ´ng cÃ³ camera");

    const cam =
      cams.find(c=>/back|rear|environment/i.test(c.label))
      || cams[cams.length-1];

    qrScanner.start(
      cam.id,
      { fps:10, qrbox:250 },
      onScan
    );
  });
}

/* ===== QUÃ‰T ===== */
function onScan(text){
  const master = load("MASTER");
  const item = master.find(x=>x.qr===text);

  if(master.length && !item) return alert("âŒ HÃ€NG NGOÃ€I");
  if(item?.sold) return alert("âŒ ÄÃƒ BÃN");
  if(item && item.store!==CURRENT_STORE) return alert("âš ï¸ SAI Cá»¬A HÃ€NG");

  qrScanner.stop();
  window.currentQR = text;

  qrValue.innerText = text;
  resultScreen.style.display="block";
}

/* ===== GHI NHáº¬N ===== */
function saveCheck(){
  const key = "CHECK_"+today()+"_"+CURRENT_STORE;
  let c = load(key).filter(x=>x!==currentQR);
  c.push(currentQR);
  save(key,c);

  let h = load("HISTORY");
  h.push({qr:currentQR,store:CURRENT_STORE,time:new Date().toLocaleString()});
  save("HISTORY",h);

  resumeScan();
}

function resumeScan(){
  resultScreen.style.display="none";
  setTimeout(startCamera,300);
}

/* ===== MASTER ===== */
function showImport(){
  if(!localStorage.getItem("ADMIN")) return alert("âŒ KhÃ´ng cÃ³ quyá»n");

  document.body.innerHTML=`
    <h3>ğŸ“¥ NHáº¬P / Cáº¬P NHáº¬T MASTER</h3>
    <textarea id="input" rows="10" style="width:100%"
      placeholder="QR001,242"></textarea><br>
    <button onclick="importMaster()">ğŸ’¾ LÆ°u</button>
    <button onclick="location.reload()">â¬… Trang chá»§</button>`;
}

function importMaster(){
  let m=[];
  input.value.trim().split("\n").forEach(l=>{
    let [qr,store]=l.split(",");
    if(qr&&store) m.push({qr:qr.trim(),store:store.trim(),sold:false});
  });
  save("MASTER",m);
  alert("âœ… MASTER Ä‘Ã£ cáº­p nháº­t");
  location.reload();
}

/* ===== BÃO CÃO ===== */
function showSummary(){
  if(!CURRENT_STORE) return alert("âŒ ChÆ°a chá»n cá»­a hÃ ng");

  const m=load("MASTER").filter(x=>!x.sold && x.store===CURRENT_STORE);
  const c=load("CHECK_"+today()+"_"+CURRENT_STORE);

  let html=`<h3>ğŸ“Š Kiá»ƒm kÃª ${CURRENT_STORE}</h3><div class="box">`;
  let warn=false;

  m.forEach(x=>{
    if(!c.includes(x.qr)){
      warn=true;
      html+=`<div class="warn">âŒ Thiáº¿u: ${x.qr}</div>`;
    }
  });

  if(!warn) html+=`<div class="ok">âœ… Táº¤T Cáº¢ ÄÃšNG</div>`;
  html+=`</div><button onclick="location.reload()">â¬… Trang chá»§</button>`;
  document.body.innerHTML=html;
}

function showHistory(){
  let html=`<h3>ğŸ“œ Lá»‹ch sá»­</h3><div class="box">`;
  load("HISTORY").forEach(x=>{
    html+=`${x.time} | ${x.qr} | CH ${x.store}<br>`;
  });
  html+=`</div><button onclick="location.reload()">â¬… Trang chá»§</button>`;
  document.body.innerHTML=html;
}
</script>

</body>
</html>
