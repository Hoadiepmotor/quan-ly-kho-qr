<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Quáº£n lÃ½ kho QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 10px;
}
#reader {
  width: 100%;
  max-width: 400px;
  margin: auto;
}
select, button, textarea {
  font-size: 16px;
  padding: 8px;
  margin: 6px;
}
.warn { color:red; font-weight:bold }
.ok { color:green; font-weight:bold }
.box {
  border:1px solid #ccc;
  padding:10px;
  margin:10px;
  border-radius:8px;
}
</style>
</head>

<body>

<h2>ğŸ“¦ Quáº£n lÃ½ kho QR</h2>

<!-- ===== MENU ===== -->
<button onclick="showImport()">ğŸ“¥ NHáº¬P DANH SÃCH CHUáº¨N</button>
<button onclick="location.reload()">ğŸ“· QUÃ‰T QR</button>

<hr>

<!-- ================= QUÃ‰T QR ================= -->
<div id="scanScreen">
  <div id="reader"></div>
</div>

<!-- ================= Káº¾T QUáº¢ ================= -->
<div id="resultScreen" style="display:none">
  <h3>ThÃ´ng tin QR</h3>
  <p id="qrValue"></p>

  <label>HÃ nh Ä‘á»™ng</label><br>
  <select id="action">
    <option value="in">Nháº­p kho</option>
    <option value="out">Xuáº¥t bÃ¡n</option>
    <option value="move">Äiá»u chuyá»ƒn</option>
    <option value="check">Kiá»ƒm kÃª</option>
  </select><br>

  <label>Cá»­a hÃ ng</label><br>
  <select id="store">
    <option>242</option>
    <option>250</option>
    <option>300</option>
    <option>239</option>
    <option>891</option>
    <option>581</option>
  </select><br>

  <button onclick="saveAction()">ğŸ’¾ LÆ°u</button>
</div>

<hr>

<button onclick="showSummary()">ğŸ“Š Káº¾T QUáº¢ KIá»‚M KÃŠ</button>
<button onclick="showHistory()">ğŸ“œ Lá»ŠCH Sá»¬</button>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
/* ===== TIá»†N ÃCH ===== */
const today = () => new Date().toISOString().slice(0,10);
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* ===== CAMERA ===== */
const qr = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(cams=>{
  const cam = cams.find(c=>c.label.toLowerCase().includes("back")) || cams[cams.length-1];
  qr.start(cam.id,{fps:10,qrbox:250},onScan);
});

/* ===== QUÃ‰T QR ===== */
function onScan(text){
  const master = load("MASTER");
  if(master.length && !master.find(x=>x.qr===text)){
    alert("âŒ QR KHÃ”NG THUá»˜C DANH SÃCH CHUáº¨N");
    return;
  }

  qr.stop();
  window.currentQR = text;
  document.getElementById("qrValue").innerHTML = "<b>"+text+"</b>";
  document.getElementById("scanScreen").style.display="none";
  document.getElementById("resultScreen").style.display="block";
}

/* ===== LÆ¯U ===== */
function saveAction(){
  const action = actionSel.value;
  const store  = storeSel.value;

  const history = load("HISTORY");
  history.push({qr:currentQR,action,store,time:new Date().toLocaleString()});
  save("HISTORY",history);

  let master = load("MASTER");
  let item = master.find(x=>x.qr===currentQR);

  if(!item){
    item = {qr:currentQR,store,sold:false};
    master.push(item);
  }

  if(action==="out") item.sold=true;
  else item.store=store;

  save("MASTER",master);

  if(action!=="out"){
    const key="CHECK_"+today();
    let checks=load(key).filter(c=>c.qr!==currentQR);
    checks.push({qr:currentQR,store});
    save(key,checks);
  }

  alert("âœ… ÄÃ£ lÆ°u");
  location.reload();
}

/* ===== NHáº¬P MASTER ===== */
function showImport(){
  document.body.innerHTML=`
    <h3>ğŸ“¥ NHáº¬P DANH SÃCH CHUáº¨N</h3>
    <textarea id="input" rows="10" style="width:100%"
    placeholder="QR001,242\nQR002,250"></textarea><br>
    <button onclick="importMaster()">ğŸ’¾ LÆ°u</button>
    <button onclick="location.reload()">â¬… Quay láº¡i</button>`;
}

function importMaster(){
  const lines=document.getElementById("input").value.trim().split("\n");
  let master=[];
  lines.forEach(l=>{
    const [qr,store]=l.split(",");
    if(qr&&store) master.push({qr:qr.trim(),store:store.trim(),sold:false});
  });
  save("MASTER",master);
  alert("âœ… ÄÃ£ nháº­p danh sÃ¡ch chuáº©n");
  location.reload();
}

/* ===== KIá»‚M KÃŠ ===== */
function showSummary(){
  const checks=load("CHECK_"+today());
  const master=load("MASTER");
  let html=`<h3>ğŸ“Š KIá»‚M KÃŠ ${today()}</h3><div class="box">`;
  let warn=false;

  master.forEach(m=>{
    if(m.sold) return;
    if(!checks.find(c=>c.qr===m.qr && c.store===m.store)){
      warn=true;
      html+=`<div class="warn">âŒ THIáº¾U: ${m.qr} | CH ${m.store}</div>`;
    }
  });

  checks.forEach(c=>{
    if(!master.find(m=>m.qr===c.qr)){
      warn=true;
      html+=`<div class="warn">âš ï¸ HÃ€NG NGOÃ€I: ${c.qr}</div>`;
    }
  });

  if(!warn) html+=`<div class="ok">âœ… Táº¤T Cáº¢ ÄÃšNG CHUáº¨N</div>`;
  html+=`</div><button onclick="location.reload()">â¬… Quay láº¡i</button>`;
  document.body.innerHTML=html;
}

/* ===== Lá»ŠCH Sá»¬ ===== */
function showHistory(){
  const h=load("HISTORY");
  let html=`<h3>ğŸ“œ Lá»ŠCH Sá»¬</h3><div class="box">`;
  h.forEach(x=>{
    html+=`${x.time} | ${x.qr} | ${x.action} | CH ${x.store}<br>`;
  });
  html+=`</div><button onclick="location.reload()">â¬… Quay láº¡i</button>`;
  document.body.innerHTML=html;
}

const actionSel=document.getElementById("action");
const storeSel=document.getElementById("store");
</script>

</body>
</html>
